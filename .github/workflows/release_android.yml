name: Android å‘å¸ƒ
on:
    workflow_dispatch:
        inputs:
            #            logLevel:
            #                description: 'Log level'
            #                required: true
            #                default: 'info'
            #                type: choice
            #                options:
            #                    - info
            #                    - warning
            #                    - debug
            desc:
                description: 'Desc'
                required: true
                type: string
jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            # æ£€å‡ºå½“å‰åˆ†æ”¯
            -   name: ===âœˆï¸âœˆï¸âœˆï¸ æ£€å‡ºåˆ†æ”¯ ===
                uses: actions/checkout@v3
            -   name: ===ğŸ”‘ğŸ”‘ğŸ”‘ æ£€å‡ºå’Œé…ç½®ç§˜é’¥ ===
                id: android_keystore
                uses: timheuer/base64-to-file@v1.0.3
                with:
                    fileName: keystore.jks
                    encodedString: ${{ env.KEYSTORE_BASE64 }}
            -   name: ==ğŸ”‘ğŸ”‘ğŸ”‘ ç”Ÿæˆkey.properties ===
                run: |
                    echo "storeFile=${{ steps.android_keystore.outputs.filePath }}" > android/key.properties
                    echo "storePassword=${{ env.STORE_PASSWORD }}" >> android/key.properties
                    echo "keyAlias=${{ env.KEY_ALIAS }}" >> android/key.properties
                    cat android/key.properties

            # åˆ é™¤æ— ç”¨æˆ–å¯èƒ½é€ æˆå…³è”çš„æ–‡ä»¶
            -   name: ===â™»ï¸â™»ï¸â™»ï¸ åˆ é™¤æ— ç”¨æˆ–å¯èƒ½é€ æˆå…³è”çš„æ–‡ä»¶ ===
                run: rm -fr .git ios README.md docs devtools_options.yaml .fvmrc obs.sh obs_tools.jar .gitignore .metadata obs_tools.cfg analysis_options.yaml .github/workflows/release_android.yml new_pkg.sh ./android/.gitignore ./android/local.properties
            # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼Œç”¨äºæ£€æŸ¥åˆ†ææ˜¯å¦å¯èƒ½å­˜åœ¨å…³è”
            -   name: ===ğŸ“ƒğŸ“ƒğŸ“ƒ åˆ é™¤æ— ç”¨æˆ–å¯èƒ½é€ æˆå…³è”çš„æ–‡ä»¶ ===
                run: find . -type f

            -   name: ===â˜•ï¸â˜•ï¸â˜•ï¸ å®‰è£…Javaå¼€å‘ç¯å¢ƒ ===
                uses: actions/setup-java@v3
                with:
                    distribution: 'zulu'
                    java-version: '17'
            # è®¾ç½® Flutter ç¯å¢ƒ
            -   name: ===ğŸ¤–ğŸ¤–ğŸ¤– å®‰è£…Flutterå¼€å‘ç¯å¢ƒ ===
                uses: subosito/flutter-action@v2
                with:
                    flutter-version: '3.19.6'
            #
            # è·å–åˆ†æ”¯åç§°
            -   name: ===ğŸ†šğŸ†šğŸ†š è®¾ç½®ç¯å¢ƒå˜é‡å’Œé…ç½® ===
                id: vars
                run: echo "branch_name=${GITHUB_REF##*/}" >> $GITHUB_ENV; echo "TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
            #
            -   run: flutter config --no-cli-animations
            -   run: flutter --version
            #
            # è¿è¡Œ Flutter çš„ pub get æ¥è·å–ä¾èµ–
            -   name: ===ğŸ”¨ğŸ”¨ğŸ”¨å¼€å§‹ç¼–è¯‘ ===
                run: flutter pub get
            # ç¼–è¯‘ APK æ–‡ä»¶
            -   name: ======== ç¼–è¯‘aab ========
                run: flutter build appbundle  --obfuscate --split-debug-info=./obfuscate

            # é‡å‘½å APK æ–‡ä»¶ä¸ºå¯¹åº”çš„åˆ†æ”¯å
            -   name: ===âœ…âœ…âœ… æ‹·è´æ„å»ºæ–‡ä»¶ âœ…âœ…âœ… ===
                run: mv build/app/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/${{env.branch_name}}_${{github.run_number}}.aab

            -   uses: ncipollo/release-action@v1
                with:
                    artifacts: "obfuscate/*,build/app/outputs/bundle/release/${{env.branch_name}}_${{github.run_number}}.aab"
                    tag: ${{env.branch_name}}-${{github.run_number}}
                    body: "${{inputs.desc}}"
